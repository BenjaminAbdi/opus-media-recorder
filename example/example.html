<!doctype html>
<html>

<head>
  <title>Opus MediaRecorder Example</title>
  <style>
    html, body {
      font-size: 40px;
      text-align: center;
    }
    .title {
      font-size: 40px;
    }
    .content {
      font-size: 16px;
    }
    div.content {
      border: 4px solid;
      border-radius: 20px;
      padding: 10px 10px 10px 10px;
      margin: 10px 10px 10px 10px;
    }
  </style>
</head>

<body>
  <div class="title">
    Opus MediaRecorder Example
  </div>

  <!-- Recording test1 -->
  <div class="content">
    <select id="mimeSelect">
      <option value="audio/opus">audio/opus</option>
      <option value="audio/wave">audio/wave</option>
    </select>
    <button id="buttonStart">start</button>
    <button id="buttonPause">pause</button>
    <button id="buttonResume">resume</button>
    <button id="buttonStop">stop</button>
    <audio id="player" controls></audio>
    <a id="link">link</a>
    <script src="MediaRecorder.js"></script>
    <script>
    var handleSuccess = function (stream) {
      // print stream information (for debugging)
      for (const track of stream.getAudioTracks()) {
        console.log('Track Information:');
        for (const key in track) {
          if (typeof track[key] !== 'function') {
            console.log(`\t${key}: ${track[key]}`);
          }
        }
        console.log('Track Settings:');
        let settings = track.getSettings();
        for (const key in settings) {
          if (typeof settings[key] !== 'function') {
            console.log(`\t${key}: ${settings[key]}`);
          }
        }
      }

      let milliSeconds = 15000;
      // Create recorder object
      if (typeof window.recorder !== 'undefined') {
        console.log('recorder already exists');
        window.recorder.start(milliSeconds);
        return;
      }
      let e = document.querySelector('#mimeSelect');
      let mimeSelect = e.options[e.selectedIndex].text;
      let config = {
        mimeType: mimeSelect
      };
      window.recorder = new MediaRecorder(stream, config);
      let { recorder } = window;

      // Start recording
      let chunks = [];
      recorder.start(milliSeconds);

      // Button Event Handlers
      let buttonPause = document.querySelector('#buttonPause');
      buttonPause.onclick = () => recorder.pause();

      let buttonResume = document.querySelector('#buttonResume');
      buttonResume.onclick = () => recorder.resume();

      let buttonStop = document.querySelector('#buttonStop');
      buttonStop.onclick = () => recorder.stop();

      // Recorder Event Handlers
      recorder.ondataavailable = function (e) {
        chunks.push(e.data);
        console.log('recorder data available');
      };

      recorder.onpause = function (e) {
        console.log('recorder paused');
      };

      recorder.onresume = function (e) {
        console.log('recrder resumed');
      };

      recorder.onstop = function (e) {
        console.log('data available after MediaRecorder.stop() called.');
        let blob = new Blob(chunks, {'type': mimeSelect});
        chunks = [];
        let audioURL = URL.createObjectURL(blob);
        let player = document.querySelector('#player');
        player.src = audioURL;
        let link = document.querySelector('#link');
        link.href = audioURL;
        console.log('recorder stopped');
      };
    };
    
    // Start Button
    var buttonStart = document.querySelector('#buttonStart');
    buttonStart.onclick = () => {
      navigator.mediaDevices.getUserMedia({audio: true, video: false})
        .then(handleSuccess);
    };
    
    // Check compability
    if (window.MediaRecorder === undefined) {
      console.error('MediaRecorder not supported, boo');
      alert('MediaRecorder not supported, boo');
    } else {
      var contentTypes = [
        'audio/wave',
        'audio/wav',
        'audio/webm',
        'audio/webm;codecs=opus',
        'audio/ogg',
        'audio/ogg;codecs=opus',
        'audio/opus'];
      contentTypes.forEach(contentType => {
        console.log(contentType + ' is ' +
          (MediaRecorder.isTypeSupported(contentType)
            ? 'supported' : 'NOT supported '));
      });
    };
    </script>
  </div>

</body>

</html>