<!doctype html>
<html>

<head>
  <title>Opus MediaRecorder Example</title>
  <style>
    html, body {
      font-size: 40px;
      text-align: center;
    }
    .title {
      font-size: 40px;
    }
    .content {
      font-size: 16px;
    }
    div.content {
      border: 4px solid;
      border-radius: 20px;
      padding: 10px 10px 10px 10px;
      margin: 10px 10px 10px 10px;
    }
    div#errorLog {
      text-align: left;
      white-space: pre;
      font-size: 12px;
    }
  </style>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Override console.log
    function override_console (old_function, div_log) {
        return function (text) {
            old_function(text);
            div_log.innerHTML += text + '<br>';
        };
    };
    console.log = override_console(console.log.bind(console), document.getElementById("errorLog"));
    console.error = override_console(console.error.bind(console), document.getElementById("errorLog"));
    console.debug = override_console(console.debug.bind(console), document.getElementById("errorLog"));
    console.info = override_console(console.info.bind(console), document.getElementById("errorLog"));
  }, false);
  </script>
</head>

<body>
  <div class="title">
    Opus MediaRecorder Example
  </div>

  <!-- Recording -->
  <div class="content">
    <select id="mimeSelect">
      <option value="">default</option>
      <option value="audio/ogg">audio/ogg</option>
      <option value="audio/webm">audio/webm</option>
      <option value="audio/wave">audio/wave</option>
      <option value="wrong_mime">wrong_mime (for testing)</option>
    </select>
    <button id="buttonStart">start</button>
    <button id="buttonPause">pause</button>
    <button id="buttonResume">resume</button>
    <button id="buttonStop">stop</button>
    <audio id="player" controls></audio>
    <a id="link">link</a>
    <script src="MediaRecorder.js"></script>
    <script>
    var recorder;
    var handleSuccess = function (stream) {
      // print stream information (for debugging)
      for (const track of stream.getAudioTracks()) {
        console.log('Track Information:');
        for (const key in track) {
          if (typeof track[key] !== 'function') {
            console.log(`\t${key}: ${track[key]}`);
          }
        }
        console.log('Track Settings:');
        let settings = track.getSettings();
        for (const key in settings) {
          if (typeof settings[key] !== 'function') {
            console.log(`\t${key}: ${settings[key]}`);
          }
        }
      }

      let milliSeconds = 15000;
      // Create recorder object
      let e = document.querySelector('#mimeSelect');
      let mimeSelect = e.options[e.selectedIndex].value;
      if (typeof recorder !== 'undefined') {
        if (recorder.mimeType !== mimeSelect) {
          console.log('a new recorder is created with different mime');
        } else {
          recorder.start(milliSeconds);
          return;
        }
      }
      if (mimeSelect) {
        let config = {
          mimeType: mimeSelect
        };
        recorder = new MediaRecorder(stream, config);
      } else {
        recorder = new MediaRecorder(stream);
      }

      // Start recording
      let chunks = [];
      recorder.start(milliSeconds);

      // Button Event Handlers
      let buttonPause = document.querySelector('#buttonPause');
      buttonPause.onclick = () => recorder.pause();

      let buttonResume = document.querySelector('#buttonResume');
      buttonResume.onclick = () => recorder.resume();

      let buttonStop = document.querySelector('#buttonStop');
      buttonStop.onclick = () => recorder.stop();

      // Recorder Event Handlers
      recorder.ondataavailable = function (e) {
        chunks.push(e.data);
        console.log('recorder data available');
      };

      recorder.onpause = function (e) {
        console.log('recorder paused');
      };

      recorder.onresume = function (e) {
        console.log('recrder resumed');
      };

      recorder.onstop = function (e) {
        console.log('data available after MediaRecorder.stop() called.');
        let blob = new Blob(chunks, {'type': mimeSelect});
        chunks = [];
        let audioURL = URL.createObjectURL(blob);
        let player = document.querySelector('#player');
        player.src = audioURL;
        let link = document.querySelector('#link');
        link.href = audioURL;
        console.log('recorder stopped');
      };
    };
    
    // Start Button
    var buttonStart = document.querySelector('#buttonStart');
    buttonStart.onclick = () => {
      if (navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({audio: true, video: false})
        .then(handleSuccess);
      } else {
        navigator.getUserMedia({audio: true, video: false}, handleSuccess, _ => {});
      }
    };
    
    // Check compability
    if (window.MediaRecorder === undefined) {
      console.error('No MediaRecorder found');
    } else {
      var contentTypes = [
        'audio/wave',
        'audio/wav',
        'audio/webm',
        'audio/webm;codecs=opus',
        'audio/ogg',
        'audio/ogg;codecs=opus',
        'audio/opus'];
      contentTypes.forEach(contentType => {
        console.log(contentType + ' is ' +
          (MediaRecorder.isTypeSupported(contentType)
            ? 'supported' : 'NOT supported '));
      });
    };
    </script>
  </div>

  <div id='errorLog'>
    <!-- console.log will be printed here -->
  </div>

</body>

</html>