<html>

<head>
  <title>opus-media-recorder Example</title>
  <style>
    html, body {
      text-align: center;
    }
    .title {
      font-size: 20px;
    }

    div.content {
      border: 4px solid;
      border-radius: 20px;
      padding: 10px 10px 10px 10px;
      margin: 10px 10px 10px 10px;
    }
    div#errorLog {
      text-align: left;
      white-space: pre;
      font-size: 12px;
    }
  </style>
  <script>
  // Overriding console.log
  document.addEventListener('DOMContentLoaded', function() {
    function override_console (old_function, div_log) {
        let count = 0;
        return function (text) {
            old_function(text);
            count += 1;
            if (count > 35) {
              let str = div_log.innerHTML;
              div_log.innerHTML = str.substring(str.indexOf("<br>") + "<br>".length);
            }
            div_log.innerHTML += text + '<br>';
        };
    };
    console.log = override_console(console.log.bind(console), document.getElementById("errorLog"));
    console.error = override_console(console.error.bind(console), document.getElementById("errorLog"));
    console.debug = override_console(console.debug.bind(console), document.getElementById("errorLog"));
    console.info = override_console(console.info.bind(console), document.getElementById("errorLog"));
  }, false);
  // Print any error
  window.onerror = function(msg, url, lineNo, columnNo, error) {
    var substring = "script error";
    if (msg.toLowerCase().indexOf(substring) > -1){
      console.log('Script Error: See Browser Console for Detail');
    } else {
      var message = [
          'Message: ' + msg,
          'URL: ' + url,
          'Line: ' + lineNo,
          'Column: ' + columnNo,
          'Error object: ' + JSON.stringify(error)
      ].join(' - ');

      console.log(message);
    }
    return false;
  };
  </script>
</head>

<body>
  <div class="title">
    Opus MediaRecorder Example
  </div>

  <!-- Recording -->
  <div class="content">
    <div>
      <label for="mimeSelect">MIME Type</label>
      <select id="mimeSelect">
        <option value="">default</option>
        <option value="audio/ogg">audio/ogg</option>
        <!-- <option value="audio/webm">audio/webm</option> -->
        <option value="audio/wave">audio/wave</option>
        <option value="wrong_mime">wrong_mime (for testing)</option>
      </select>
    </div>
    <div>
      <label for="timeSlice">timeslice (in milliseconds)</label>
      <input id="timeSlice" type="number" step="100" value="10000"/>
    </div>
    <div>
      <button id="buttonCreate">create</button>
      <button id="buttonStart">start</button>
      <button id="buttonPause">pause</button>
      <button id="buttonResume">resume</button>
      <button id="buttonStop">stop</button>
      <button id="buttonStopTracks">stop tracks</button>
    </div>
    <script src="assets/MediaRecorder.js"></script>
    <script>
    var recorder;
    var milliSeconds = 15000;

    var createMediaRecorder = function (stream) {
      if (recorder && recorder.state !== 'inactive') {
        console.log('Stop the recorder first');
      }

      // Create recorder object
      let e = document.querySelector('#mimeSelect');
      let mimeSelect = e.options[e.selectedIndex].value;
        let config = {
          mimeType: mimeSelect
        };
        recorder = new MediaRecorder(stream, config);

      let dataChunks = [];
      // Recorder Event Handlers
      recorder.ondataavailable = function (e) {
        console.log('Recorder data available');
        dataChunks.push(e.data);
      };
      // When stopped add a link to the player and the download link
      recorder.onstop = function (e) {
        // Create a file
        let blob = new Blob(dataChunks, {'type': recorder.mimeType});
        dataChunks = [];
        let audioURL = URL.createObjectURL(blob);
        let player = document.querySelector('#player');
        player.src = audioURL;
        let link = document.querySelector('#link');
        link.href = audioURL;

        console.log('Recorder stopped');
      };
      recorder.onstart = _ => {
        dataChunks = [];
        console.log('Recorder started');
      };
      // Other handlers
      recorder.onpause = _ => console.log('Recorder paused');
      recorder.onresume = _ => console.log('Recorder resumed');
      recorder.onerror = _ => console.log('Recorder encounters error');

      // Just for debugging purpose.
      printStreamInfo(stream);

      console.log('Creating MediaRecorder is successful.');
    };

    // Button Event Handlers
    // Create Button
    var buttonCreate = document.querySelector('#buttonCreate');
    buttonCreate.onclick = () => {
      if (navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({audio: true, video: false})
        .then(createMediaRecorder);
      } else {
        navigator.getUserMedia({audio: true, video: false}, createMediaRecorder, _ => {});
      }
    };
    // Start Button
    var buttonStart = document.querySelector('#buttonStart');
    buttonStart.onclick = () => {
      if (recorder) {
        recorder.start(milliSeconds);
      }
    };
    // Puase Button
    let buttonPause = document.querySelector('#buttonPause');
    buttonPause.onclick = _ => {
      if (recorder) {
        recorder.pause();
      }
    };
    // Resume Button
    let buttonResume = document.querySelector('#buttonResume');
    buttonResume.onclick = _ => {
      if (recorder) {
        recorder.resume();
      }
    };
    let buttonStop = document.querySelector('#buttonStop');
    buttonStop.onclick = _ => {
      if (recorder) {
        recorder.stop();
      }
    };
    let buttonStopTracks = document.querySelector('#buttonStopTracks');
    buttonStopTracks.onclick = _ => {
      if (recorder) {
        // stop all tracks (this will delete a mic icon from a browser tab
        recorder.stream.getTracks().forEach(i => i.stop());
        console.log('Tracks (stream) stopped. click \'Create\' button to capture stream.');
      }
    };
    
    // Overriding console.log
    document.addEventListener('DOMContentLoaded', function() {
      // Check compability
      if (window.MediaRecorder === undefined) {
        console.error('No MediaRecorder found');
      } else {
        var contentTypes = [
          'audio/wave',
          'audio/wav',
          // 'audio/webm',
          // 'audio/webm;codecs=opus',
          'audio/ogg',
          'audio/ogg;codecs=opus',
        ];
        contentTypes.forEach(type => {
          console.log(type + ' is ' +
            (MediaRecorder.isTypeSupported(type)
              ? 'supported' : 'NOT supported'));
        });
      }
    }, false);

    // print stream information (for debugging)
    function printStreamInfo (stream) {
      for (const track of stream.getAudioTracks()) {
        console.log('Track Information:');
        for (const key in track) {
          if (typeof track[key] !== 'function') {
            console.log(`\t${key}: ${track[key]}`);
          }
        }
        console.log('Track Settings:');
        let settings = track.getSettings();
        for (const key in settings) {
          if (typeof settings[key] !== 'function') {
            console.log(`\t${key}: ${settings[key]}`);
          }
        }
      }
    }
    </script>
  </div>

  <div class="player">
    <audio id="player" controls></audio>
    <a id="link">link</a>
  </div>

    <!-- console.log will be printed here -->
  <div id='errorLog'></div>

</body>

</html>